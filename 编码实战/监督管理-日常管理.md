# 监督管理-日常管理

## 背景和目的

打工人朝九晚六是常态，上班打卡和下班打卡是资本家常用的手段!

模拟业务场景：社区矫正的日常核查和个人抽查

说明：在简单化的模拟真实的业务场景下，让大家更接近真实的开发！

## 需求分析

日常核查:管理员设置不同监管类型的人在不同的时间段内打卡

个人抽查:管理人员设置指定的人在指定的时间段内打卡

需求：如果监管人员没有在规定的时间内打卡就需要生成对应类型的报警

存在问题：监管人员被指定的日常核查和个人抽查的时候时间冲突的问题！

## 表结构设计

用户表user

| Field | Type        | Comment  |
| ----- | ----------- | -------- |
| id    | varchar(32) | 主键     |
| name  | varchar(32) | 姓名     |
| type  | varchar(32) | 监管类型 |

日常核查表daily_check

| Field                  | Type        | Comment      |
| ---------------------- | ----------- | ------------ |
| id                     | varchar(32) | 主键         |
| daily_check_start_time | date        | 核查开始时间 |
| daily_check_end_time   | date        | 核查结束时间 |
| type                   | varchar(32) | 监管类型     |

个人抽查表personal_check

| Field                     | Type        | Comment                    |
| ------------------------- | ----------- | -------------------------- |
| id                        | varchar(32) | 主键                       |
| user_id                   | varchar(32) | 外键，用户主键             |
| personal_check_start_time | date        | 抽查开始时间               |
| personal_check_end_time   | date        | 抽查结束时间               |
| task_state                | varchar(1)  | 抽查任务生成状态：0无、1有 |

核查任务表check_task

| Field            | Type        | Comment        |
| ---------------- | ----------- | -------------- |
| id               | varchar(32) | 主键           |
| user_id          | varchar(32) | 外键，用户主键 |
| check_start_time | date        | 检查开始时间   |
| check_end_time   | date        | 检查结束时间   |
| task_type        | varchar(32) | 检查类型       |
| task_state       | varchar(1)  | 任务状态       |

打卡表clock

| Field      | Type        | Comment        |
| ---------- | ----------- | -------------- |
| id         | varchar(32) | 主键           |
| user_id    | varchar(32) | 外键，用户主键 |
| clock_time | date        | 打卡时间       |

## 解决方案

### 生成核查任务

步骤：

- 根据日常核查生成核查任务，因为日常核查时间比较稳定，故使用定时任务实现

- 根据个人抽查生成核查任务，因为个人抽查时间不确定，所以使用定时任务（5s/次）实现近乎实时的生成核查任务

  - 查询满足时间的记录
    - 抽查结束时间<=当前时间
    - 抽查任务生成状态=0

  - 根据满足时间的数据生成日常信息化核查表
  - 更新抽查任务生成状态=1

### 生成报警信息

步骤：

- 获取打卡表

- 根据核查任务表获取核查任务
  - 核查结束时间<=当前时间
  - 核查任务生成状态=0
- 生成报警信息
- 更新核查任务生成状态=1