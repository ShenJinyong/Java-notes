# 监督管理-监管地图

## 背景和目的

在我们的人插板阀生活中，很多时候我们需要去监控设备的在线离线状态。

模拟业务场景：社区矫正的监管地图显示设备在线离线状态

说明：在简单化的模拟真实的业务场景下，让大家更接近真实的开发！

## 需求分析

需求：设备在线离线的状态需要实时显示，设备离线后需要产生设备离线报警

问题：可能存在设备一直不在线问题

## 表结构设计

用户表user

| Field | Type        | Comment  |
| ----- | ----------- | -------- |
| id    | varchar(32) | 主键     |
| name  | varchar(32) | 姓名     |

设备表device

| Field   | Type        | Comment       |
| ------- | ----------- | ------------- |
| id      | varchar(32) | 主键          |
| user_id | varchar(32) | 外键,用户主键 |

设备定位表device_location

| Field     | Type        | Comment  |
| --------- | ----------- | -------- |
| id        | varchar(32) | 主键     |
| device_id | varchar(32) | 设备主键 |
| location  | varchar(32) | 定位信息 |

## 解决方案

**采用Redis的键过期事件监听的实现**

步骤：

- 服务启动时，查询所有设备进行设备定位和过期时间初始化
  - 采用RedisTemplate二次封装工具包
  - 如果没有设备所对应key的话，设置key和过期时间
  - 如果有设备所对应key的话，就更新设备过期时间
- 设备发送定位更新设备定位表，同时去更新Redis的过期
- 监听Redis的键过期事件，如果是设定规则的key就产生设备离线报警，删除过期的key
- 设备数(数据库)=在线设备(Redis中key的数量)+离线设备
